#!/bin/bash
# combustion: network

# Redirect output to the console
exec > >(exec tee -a /dev/tty0) 2>&1

# Set hostname
echo ${VMNAME} > /etc/hostname
hostname ${VMNAME}

# Registration
if [ ${REGISTER} = true ]; then
	if ! which SUSEConnect > /dev/null 2>&1; then
		zypper --non-interactive install suseconnect-ng
	fi
	SUSEConnect --email ${EMAIL} --url https://scc.suse.com --regcode ${REGCODE}
fi

# K3s
if [ ${K3S} = true ]; then
	# Stolen from https://code.opensuse.org/adathor/combustion-dotconf/blob/main/f/K3s%20cluster/k3s_master/script
	INSTALL_K3S_EXEC='server --cluster-init --write-kubeconfig-mode=644'
	# Download and install the latest k3s installer (it seems /usr/local/bin/ doesn't exist at this stage)
	curl -L --output k3s_installer.sh https://get.k3s.io && install -m755 k3s_installer.sh /usr/bin/
	# Create a systemd unit that installs k3s if not installed yet. The k3s service is started after the installation
	cat <<- EOF > /etc/systemd/system/install-k3s.service
	[Unit]
	Description=Run K3s installer
	Wants=network-online.target
	After=network.target network-online.target
	ConditionPathExists=/usr/bin/k3s_installer.sh
	ConditionPathExists=!/usr/local/bin/k3s

	[Service]
	Type=forking
	TimeoutStartSec=120
	Environment="INSTALL_K3S_EXEC=$INSTALL_K3S_EXEC"
	Environment="INSTALL_K3S_VERSION=${K3s_VERSION}"
	ExecStart=/usr/bin/k3s_installer.sh
	RemainAfterExit=yes
	KillMode=process
	ExecStartPost=/bin/sh -c "systemctl start k3s"
	
	[Install]
	WantedBy=multi-user.target
	EOF

	systemctl enable install-k3s.service

fi

# Rancher
if [ ${RANCHER} = true ]; then
	# Download helm as required to install rancher (it seems /usr/local/bin/ doesn't exist at this stage)
	export HELM_INSTALL_DIR="/usr/bin/" && curl -fsSL https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 |bash

	# Create a script to install rancher that will be called via a systemd service
	cat <<- EOF > /usr/bin/rancher_installer.sh
	#!/bin/bash

	# Wait for k3s to be available
	until [ -f /etc/rancher/k3s/k3s.yaml ]; do sleep 2; done
	export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
	# Wait for the node to be available, meaning the K8s API is available
	while ! kubectl wait --for condition=ready node $(cat /etc/hostname | tr '[:upper:]' '[:lower:]') --timeout=60s; do sleep 2 ; done

	# https://ranchermanager.docs.rancher.com/pages-for-subheaders/install-upgrade-on-a-kubernetes-cluster
	helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
	helm repo add jetstack https://charts.jetstack.io
	# Update your local Helm chart repository cache
	helm repo update

	# Install the cert-manager Helm chart
	helm install cert-manager jetstack/cert-manager \
	  --namespace cert-manager \
	  --create-namespace \
		--set installCRDs=true \
	  --version v1.11.0
	
	# Install rancher using sslip.io as hostname and with just a single replica
	helm install rancher rancher-latest/rancher \
  	--namespace cattle-system \
		--create-namespace \
  	--set hostname=$(hostname -I | awk '{print $1}').sslip.io \
  	--set bootstrapPassword=${RANCHERBOOTSTRAPPASSWORD} \
		--set replicas=1 \
		--set global.cattle.psp.enabled=false

	# By creating this file, the install-rancher systemd service won't be executed again
	touch /root/.rancher_installed
	EOF

	chmod a+x /usr/bin/rancher_installer.sh

	# Create a systemd unit to install rancher once
	# Using "User=root" is required for some environment variables to be present 
	cat <<- EOF > /etc/systemd/system/install-rancher.service
	[Unit]
	Description=Deploy Rancher on K3s
	Wants=network-online.target
	After=network.target network-online.target k3s.service
	ConditionPathExists=/usr/bin/rancher_installer.sh
	ConditionPathExists=!/root/.rancher_installed

	[Service]
	User=root
	Type=forking
	TimeoutStartSec=120
	ExecStart=/usr/bin/rancher_installer.sh
	RemainAfterExit=yes
	KillMode=process

	[Install]
	WantedBy=multi-user.target
	EOF

	systemctl enable install-rancher.service
fi

# Leave a marker
echo "Configured with combustion" >> /etc/issue.d/combustion
